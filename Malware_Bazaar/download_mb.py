import wget
import zipfile
import os
import csv
from datetime import datetime, timedelta


#format year-month-day
today = datetime.today()
format_today = today.strftime("%Y-%m-%d")
yesterday = today - timedelta(days=1)
format_yesterday = yesterday.strftime("%Y-%m-%d")


try:
	#Download latest daily malware examples
	print(20 * "--")
	print(f"Downloading latest malware batch: {format_yesterday}")
	file = wget.download(f"https://datalake.abuse.ch/malware-bazaar/daily/{format_yesterday}.zip")
	print(f"{file} downloaded")
	print(20 * "--")
except:
	print("Download failed")

csv_batch = f"{format_yesterday}.csv"


try:
	#Opening zip file to get file names
	print("Extracting SHA256 to CSV file")
	print(20 * "--")
	with zipfile.ZipFile(file, "r") as f:
		#create list of content in zip
		names = f.namelist()
		for name in names:
			split_name = name.split(".")
			remove_extension = split_name.pop(1) #remove extensions
			with open(csv_batch, mode='a', newline='') as csv_file:
				csv_writer = csv.writer(csv_file)
				csv_writer.writerow(split_name)
				csv_file.close()
	print(f"Hashes extracted toc {csv_batch} ")
	print(20 * "--")
except:
	print("Failed to open zip or write files to .csv")
